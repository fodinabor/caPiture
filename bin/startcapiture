#!/bin/bash

error

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
export PATH="$SCRIPT_DIR:$PATH"

# Add a fake X session
echo "DISPLAY=:0" > "$SCRIPT_DIR/setsession"
dbus-launch >> "$SCRIPT_DIR/setsession"
chmod +x "$SCRIPT_DIR/setsession"
. "$SCRIPT_DIR/setsession"

export DISPLAY
export DBUS_SESSION_BUS_ADDRESS
export DBUS_SESSION_BUS_PID

start_jack () {
    # Start JACK server
    jackd -dalsa -dhw:"Microphone" -r44100 -p2048 -n3 &
    JACKD_PID=$!

    exit_trap () {
        kill $HOTKEYS_PID
        kill $JACKD_PID
        error
    }
    trap exit_trap EXIT
}

start_jack    
while ! jack_wait -w -t 10; do
    echo "JACK server not started, retrying..."
    start_jack
done

steady

# Start listening for buttons on pin 4 and 17
hotkeys &
HOTKEYS_PID=$!

wait
