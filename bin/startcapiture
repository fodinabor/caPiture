#!/bin/bash

error

# Log IP info
ip addr > $HOME/Musik/ipinfo.txt

DEVICE_NAME="X18XR18"

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
export PATH="$SCRIPT_DIR:$PATH"

# Add a fake X session
echo "DISPLAY=:0" > "/tmp/capituresetsession"
dbus-launch >> "/tmp/capituresetsession"
chmod +x "/tmp/capituresetsession"
. "/tmp/capituresetsession"

export DISPLAY
export DBUS_SESSION_BUS_ADDRESS
export DBUS_SESSION_BUS_PID

HOTKEYS_PID=
JACK_PID=

setup_exit_trap() {
    exit_trap () {
        if [ -n "$HOTKEYS_PID" ]; then
            kill $HOTKEYS_PID
        fi
        if [ -n "$JACKD_PID" ]; then
            kill $JACKD_PID
        fi
        error
    }
    trap exit_trap EXIT
}

start_jack () {
    # Start JACK server
    jackd -dalsa -dhw:"$DEVICE_NAME" -r44100 -p2048 -n3 &
    JACKD_PID=$!
    setup_exit_trap
}

start_jack    
while ! jack_wait -w -t 10; do
    echo "JACK server not started, retrying..."
    start_jack
done

steady

# Start listening for buttons on pin 4 and 17
hotkeys &
HOTKEYS_PID=$!
setup_exit_trap

DEVICE="/proc/asound/$DEVICE_NAME"

while true; do
    if [ ! -d "$DEVICE" ]; then
        pkill jackd
        error
        start_jack
        while ! jack_wait -w -t 10; do
            echo "JACK server not started, retrying..."
            start_jack
        done
        steady
    fi
    sleep 1
done

wait
