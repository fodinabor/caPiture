#!/bin/bash

FILE=$HOME/Musik/$(date +%F-%H_%M_%S).wav
CHANNEL=2
CHIP=pwmchip0
PWM=pwm$CHANNEL

IS_RECORDING=$(ps aux | grep jack_capture | wc -l)
if [ $IS_RECORDING -gt 1 ]; then
    echo "Already recording!"
    exit 1
fi

# Start recording and blinking
blink

sleep 2

record () {
    ports="system:capture_1    system:capture_2    system:capture_3    system:capture_4    system:capture_17    system:capture_18"
    capture_ports="-p system:capture_1 -p system:capture_2 -p system:capture_3 -p system:capture_4 -p system:capture_17 -p system:capture_18"
    # ports=$(jack_lsp -c | grep -P "^system:capture_" | awk '{print $1}' | tr '\n' ' ')
    jack_meter -n -r 0 -l /sys/class/pwm/$CHIP/$PWM/ ${ports} 2> /dev/null &
    METER_TO_PWM_PID=$!

    jack_capture -fn $FILE -ns -dm -dc ${capture_ports}

    kill ${METER_TO_PWM_PID}

    blink
    sleep 1

    exit_trap () {
        steady
    }
    trap exit_trap EXIT
}

record &

# eq 1 means only the grep process is found
while [ $(ps aux | grep jack_capture | wc -l) -eq 1 ]; do
    echo "jack_capture not started yet, waiting..."
    sleep 1
done
